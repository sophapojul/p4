<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modal.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modal.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable consistent-return */
/* eslint-disable func-names */
/**
 * @const
 * @type  {HTMLInputElement}
 */
const icon = document.querySelector('.icon');
/**
 * @const
 * @type  {NodeList}
 */
const myLinks = document.querySelectorAll('.main-navbar a+a');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const dialog = document.querySelector('#dialog');
/**
 * The above code is selecting the element with the id of reserve.
 *
 * @const  {HTMLFormElement}  reserve  inscription form
 */
const reserve = document.querySelector('#reserve');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const first = document.querySelector('#first');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const last = document.querySelector('#last');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const email = document.querySelector('#email');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const birthdate = document.querySelector('#birthdate');
/**
 * @const
 * @type  {HTMLInputElement}
 */
const quantity = document.querySelector('#quantity');

const textRegExp = /^(?=.{2,30}$)[\p{L}]+(?:['\-\s][p{L}]+)*$/iu;
const emailRegExp = /^[\w][\w.-]+[@]{1}[\w.-]+[.]{1}[a-zA-Z]{2,3}$/i;
const numberRegExp = /^(0?\d|[1-9]\d)$/;
const emptyErrMsg = 'Le champ ne peut-être vide.';
const textErrMsg =
  "Le champ doit contenir au moins 2 caractères alphabétiques, ne pas avoir d'espace en début et fin de saisie et si besoin un trait d'union - ou une apostrophe ' ou un espace .";
const emailErrMsg = 'Le champ doit contenir une adresse mail valide.';
const dateErrMsg =
  'Le champ doit contenir une date valide et vous devez avoir 12 ans.';
const numberErrMsg =
  'Vous devez saisir un nombre entier positif inférieur à 100.';
const radiosErrMsg = 'Vous devez choisir une ville.';
const cguErrMsg =
  "Vous devez avoir lu et accepté les conditions d'utilisations.";

// const emailRegExp = /^\w+([.-_]?\w+)*@\w+([.-]?\w+)*(\.[a-z]{2,3})+$/i;d

const triggers = document.querySelectorAll('[aria-haspopup="dialog"]');
const dismissTriggers = dialog.querySelectorAll('[data-dismiss]');

let modal = null;
let previousActiveElement = null;

/**
 * The function is called when the user clicks on the hamburger icon. The function toggles the class of
 * the navbar to responsive
 */
function editNav() {
  const myTopnav = document.getElementById('myTopnav');
  myTopnav.classList.toggle('responsive');
}

icon.addEventListener('click', editNav);
/**
 * It takes an element as an argument, removes the active class from all of its siblings, and adds the
 * active class to itself
 * @param  el - the element that was clicked
 */
function setActive(el) {
  [...el.parentElement.children].forEach((sib) => {
    if (sib.classList.contains('active')) {
      sib.classList.remove('active');
    }
  });
  el.classList.add('active');
}
/* The above code is adding an event listener to each link in the navbar. When the link is clicked, the
setActive function is called. */
[...myLinks].forEach((el) => {
  el.addEventListener('click', () => {
    setActive(el);
  });
});

/**
 * It traps the focus inside the dialog box
 * @param  {HTMLElement} el - The element that will be focused on when the dialog is opened.
 */
function trapFocus(el) {
  /**
   * [firstFocusableElt description]
   * @let focusableElts
   * @type {Array}
   */
  const focusableElts = Array.from(
    el.querySelectorAll(
      'input,span[role=radio],span[role=checkbox],button[type=submit],button[data-dismiss=dialog],span[data-dismiss="dialog"]'
    )
  );
  /**
   * [firstFocusableElt description]
   * @let firstFocusableElt
   * @type {HTMLElement}
   */
  const firstFocusableElt = focusableElts[0];
  /**
   * [firstFocusableElt description]
   * @let lastFocusableElt
   * @type {HTMLElement}
   */
  const lastFocusableElt = focusableElts[focusableElts.length - 1];
  const KEYCODE_TAB = '9';
  el.addEventListener('keydown', (ev) => {
    const isTabPressed = ev.key === 'Tab' || ev.code === KEYCODE_TAB;

    if (!isTabPressed) {
      return;
    }

    if (ev.shiftKey) {
      /* shift + tab */ if (document.activeElement === firstFocusableElt) {
        lastFocusableElt.focus();
        ev.preventDefault();
      }
    } /* tab */ else if (document.activeElement === lastFocusableElt) {
      firstFocusableElt.focus();
      ev.preventDefault();
    }
  });
}
/**
 * It closes the modal
 * @param   {Event}  ev - the event object
 * @returns The function closeModal is being returned.
 */
function closeModal(ev) {
  if (!modal) return;
  ev.preventDefault();
  // eslint-disable-next-line no-use-before-define
  Array.from(document.querySelector('#myTopnav').children).forEach((child) =>
    child.removeAttribute('inert')
  );
  Array.from(document.querySelector('main').children).forEach(
    /**
     * @type {function}
     * @param  {Element} child
     */
    (child) => {
      if (child !== modal) {
        child.removeAttribute('inert');
      }
    }
  );
  modal.removeAttribute('style');
  modal.setAttribute('aria-hidden', 'true');
  modal.removeAttribute('aria-modal');
  modal.removeEventListener('click', closeModal);
  modal
    .querySelector('span[data-dismiss="dialog"]')
    .removeEventListener('click', closeModal);
  modal.lastElementChild.removeEventListener('click', closeModal);
  // eslint-disable-next-line no-use-before-define
  document.removeEventListener('keydown', checkCloseModal);
  // restoring focus
  previousActiveElement.focus();
  modal = null;
}

function checkCloseModal(ev) {
  if (ev.key === 'Enter' &amp;&amp; ev.target.type === 'submit') {
    // ev.preventDefault();
    // document.querySelector('#reserve').submit();
    ev.target.click();
  }
  if (ev.key === 'Escape' || ev.key === 'Enter') {
    closeModal(ev);
  }
}
/**
 * It sets the modal to open
 * @param  {HTMLElement} el - the modal element
 */
function setToOpenModal(el) {
  Array.from(document.querySelector('#myTopnav').children).forEach((child) =>
    child.setAttribute('inert', 'true')
  );
  Array.from(document.querySelector('main').children).forEach(
    /**
     * @type {function(Element)}
     */
    (child) => {
      if (child !== el) child.setAttribute('inert', 'true'); // child.inert = true;
    }
  );
  el.setAttribute('style', 'display: block');
  el.removeAttribute('aria-hidden');
  el.setAttribute('aria-modal', 'true');
  el.querySelectorAll('[data-dismiss="dialog"]').forEach((elt) =>
    elt.addEventListener('click', closeModal)
  );
  el.lastElementChild.addEventListener('click', closeModal);
  document.addEventListener('keydown', checkCloseModal);
  trapFocus(el);
  modal = el;
}
/**
 * If there is no modal open, set the modal to the element that was clicked on and set the trigger to
 * the element that was clicked on.
 * @param   {Event}  ev - the event object
 */
const openModal = (ev) => {
  ev.preventDefault();
  /**
   * @const btn
   * @type {EventTarget}
   */
  const btn = ev.target;
  // @ts-ignore
  const el = document.getElementById(btn.getAttribute('aria-haspopup'));
  if (!modal) {
    previousActiveElement = document.activeElement;
    setToOpenModal(el);
  }
};

/**
 * It adds an event listener to each trigger element, which opens the modal when the trigger is clicked or Enter is pressed, which closes the modal when the trigger is clicked or Escape is pressed.
 */
triggers.forEach((trigger) => {
  /**
   * The above code is adding an event listener to the trigger element. When the trigger element is
  clicked, the openModal function is called.
   *
   * @param   {String}  click
   * @param   {PointerEvent|KeyboardEvent}  ev
   *
   */
  trigger.addEventListener('click', openModal);
  trigger.addEventListener('keydown', (ev) => {
    // @ts-ignore
    if (ev.key === 'Enter') {
      ev.preventDefault();
      openModal(ev);
    }
  });
  /* Closing the modal when the user clicks on the button. */
  dismissTriggers.forEach((dismissTrigger) => {
    dismissTrigger.addEventListener('click', closeModal);
  });
});
/**
 * It adds an error message to the form field if it doesn't already have one
 * @param {HTMLInputElement} el - the element that triggered the event
 * @param {String} message - the error message to display
 * @returns the value of the variable eltLastChild.
 */
function setErrMsg(el, message) {
  const eltLastChild = el.parentElement.lastChild;
  // test présence d'un message d'erreur
  if (
    eltLastChild.nodeName === 'SMALL' &amp;&amp;
    eltLastChild.textContent === message
  ) {
    return;
  } // sinon création du message d'erreur :
  // création de l'élément contenant le message
  eltLastChild.textContent = '';
  const errElt = document.createElement('small');
  // ajout du message à l'élément créé
  errElt.textContent = message; // 'Votre prénom doit contenir au moins 2 lettres';
  errElt.style.color = 'red';
  el.parentElement.insertAdjacentElement('beforeend', errElt);
  // ajout de la classe invalid au parent
  el.parentElement.classList.remove('valid');
  el.parentElement.classList.add('invalid');
  if (el.getAttribute('type') === 'checkbox') {
    document
      .querySelector('#checkbox1')
      .nextElementSibling.firstElementChild.setAttribute(
        'style',
        'border:2px solid red;'
      );
  }
}
// TODO set valid message and delete previous message

/**
 * It removes the error message and replaces the class `invalid` by the class `valid` on the parent
 * element of the element passed as argument
 * @param {HTMLInputElement} el - the element that triggered the event
 */
function removeErrMsg(el) {
  const eltLastChild = el.parentElement.lastChild;
  // test présence d'un message d'erreur
  if (eltLastChild.nodeName === 'SMALL') {
    // suppression du message d'erreur
    eltLastChild.remove();
    // remplacement de la classe invalid par la classe valid sur le parent
    el.parentElement.classList.remove('invalid');
    el.parentElement.classList.add('valid');
    if (el.getAttribute('type') === 'checkbox') {
      document
        .querySelector('#checkbox1')
        .nextElementSibling.firstElementChild.removeAttribute('style');
    }
  }
  el.parentElement.classList.add('valid');
}

/**
 * It takes a value and a regular expression and returns true if the value matches the regular
 * expression
 * @param {HTMLInputElement}el - The value to test.
 * @param {RegExp} regExp - The regular expression to test against.
 * @returns true or false
 */
function testRegExp(el, regExp) {
  const testedValue = regExp.test(el.value.trim());
  return !!testedValue;
}

/**
 * If the selector is not null, return true.
 * @param   {HTMLInputElement} el - The selector to check.
 * @returns   {Boolean} A boolean value.
 */
function notNull(el) {
  return el !== null;
}

/**
 * If the input is not empty, remove the error message and return true, otherwise set the error message
 * and return false
 * @param  {HTMLInputElement} elt - The input element that is being validated.
 * @returns  {Boolean} A boolean value.
 */
function notEmpty(elt) {
  const el = elt;
  // const dataLength = el.value.trim().length;
  switch (el.getAttribute('type')) {
    case 'text':
    case 'email':
    case 'number':
    case 'date':
      if (el.value) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, emptyErrMsg);
      return false;
    default:
      return true;
  }
}

/**
 * It checks if the input is valid, and if it is, it removes the error message, otherwise it sets the
 * error message
 * @param  {HTMLInputElement} elt - the element to check
 * @returns   {Boolean} A boolean value.
 */
function valid(elt) {
  const el = elt;
  const age = new Date().getFullYear() - new Date(el.value).getFullYear();
  // TODO check once notNull and notEmpty cf inputValid
  if (!notNull(el) || !notEmpty(el)) {
    setErrMsg(el, emptyErrMsg);
    return false;
  }
  // TODO check message
  removeErrMsg(el);
  switch (el.type) {
    case 'text':
      if (testRegExp(el, textRegExp)) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, textErrMsg);
      return false;
    case 'email':
      if (testRegExp(el, emailRegExp)) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, emailErrMsg);
      return false;
    case 'date':
      if (
        new Date(el.value).toString() === 'Invalid Date' ||
        new Date(el.value).getFullYear() &lt; 1900 ||
        age &lt; 12
      ) {
        setErrMsg(el, dateErrMsg);
        return false;
      }
      return true;
    case 'number':
      if (testRegExp(el, numberRegExp)) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, numberErrMsg);
      return false;
    case 'checkbox':
      if (el.checked) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, cguErrMsg);
      return false;
    case 'radio':
      if (el.checked) {
        removeErrMsg(el);
        return true;
      }
      setErrMsg(el, radiosErrMsg);
      el.parentElement.style.border = '1px solid red';
      return false;
    default:
      return false;
  }
}

/**
 * If the first name field is not empty, then validate it
 * @returns  {Boolean} The function firstValid() is being returned.
 */
function firstValid() {
  // @ts-ignore
  return valid(first);
}

/**
 * If the last name is not empty, then validate it
 * @returns  {Boolean} The function lastValid() is being returned.
 */
function lastValid() {
  // @ts-ignore
  return valid(last);
}

/**
 * If the email field is not empty, then validate it
 * @returns  {Boolean} a boolean value.
 */
function emailValid() {
  // @ts-ignore
  return valid(email);
}

/**
 * It checks if the birthdate input is not empty, and if it's not, it checks if the date is valid. If
 * it is, it checks if the date is in the correct format
 * @returns  {Boolean} A boolean value.
 */
function birthdateValid() {
  // @ts-ignore
  return valid(birthdate);
}

/**
 * If the quantity field is not empty, then validate it using the regular expression.
 * @returns  {Boolean} the value of the function valid.
 */
function quantityValid() {
  // @ts-ignore
  return valid(quantity);
}

/**
 * It checks if a radio button is selected, and if not, it displays an error message
 */
function isSelected() {
  const selected = document.querySelector('input[name="location"]:checked');
  if (selected) {
    if (document.querySelector('#formRadio').nextSibling.nodeName === 'SMALL') {
      document.querySelector('#formRadio').nextSibling.remove();
      document.querySelector('#formRadio').removeAttribute('style');
    }
    return true;
  }
  if (document.querySelector('#formRadio').nextSibling.nodeName !== 'SMALL') {
    const errElt = document.createElement('small');
    errElt.textContent = radiosErrMsg;
    document
      .querySelector('#formRadio')
      .insertAdjacentElement('afterend', errElt);
    // @ts-ignore
    document.querySelector('#formRadio').nextSibling.style.fontSize = '.8rem';
    // @ts-ignore
    document.querySelector('#formRadio').nextSibling.style.color = 'red';
    // @ts-ignore
    document.querySelector('#formRadio').style.border = '2px solid red';

    return false;
  }
}

/**
 * It checks if the checkbox is checked, if not, it displays an error message, if it is, it removes the
 * error message
 * @returns {Boolean} A boolean value.
 */
function cguChecked() {
  /**
   *@const cgu - a node
   *@type  {HTMLInputElement}
   */
  const cgu = document.querySelector('#checkbox1');
  if (!cgu.checked) {
    setErrMsg(cgu, cguErrMsg);
    return false;
  }
  removeErrMsg(cgu);
  return cgu.checked;
}

/**
 * It returns true if all the other functions return true
 * @returns {Boolean} A boolean value.
 */
function validate() {
  const validated = !!(
    firstValid() &amp;&amp;
    lastValid() &amp;&amp;
    emailValid() &amp;&amp;
    birthdateValid() &amp;&amp;
    quantityValid() &amp;&amp;
    isSelected() &amp;&amp;
    cguChecked()
  );
  return validated;
}

/**
 * It creates a modal window with a success message and displays it
 * @param   {String} firstname - the first name of the user
 * @param   {String} lastname - the last name of the user
 */
function displaySuccessModal(firstname, lastname) {
  /**
   * @const
   * @type {HTMLElement}
   */
  const div = document.createElement('div');
  div.setAttribute('id', 'successModal');
  div.setAttribute('class', 'modal, successModal');
  div.setAttribute('role', 'dialog');
  div.innerHTML = `
    &lt;div class="modal-content" role="document">
      &lt;span
        tabindex="0"
        role="button"
        id="dismissSuccessModal"
        class="modal-close"
        aria-label="Fermer la fenêtre modale"
        title="Fermer la fenêtre modale"
        data-dismiss="dialog"
      >&lt;/span>
      &lt;div class="modal-body">
        &lt;h3>Merci pour votre inscription ! &lt;span>${firstname} ${lastname}&lt;/span>&lt;/h3>
        &lt;button class="button" data-dismiss="dialog">Fermer&lt;/button>
      &lt;/div>
    &lt;/div>
    &lt;div class="modal-mask">&lt;/div>
  `;
  document.querySelector('main').appendChild(div);
  /**
   * @const
   * @type  {HTMLElement}
   */
  const successModal = document.querySelector('#successModal');
  setToOpenModal(successModal);
}
/* The above code is adding an event listener to each of the radio buttons. When the user presses the
enter or space key, the radio button is checked. */
Array.from(document.querySelectorAll('span[role="radio"]')).forEach(
  (element) => {
    element.addEventListener('keydown', (ev) => {
      // @ts-ignore
      if (ev.code === 'Enter' || ev.code === 'Space') {
        document.querySelector(
          `input[value="${document.activeElement.getAttribute('aria-label')}"]`
          // @ts-ignore
        ).checked = true;
        document
          .querySelector(
            `input[value="${document.activeElement.getAttribute(
              'aria-label'
            )}"]`
          )
          .nextElementSibling.firstElementChild.setAttribute(
            'aria-checked',
            'true'
          );
      }
    });
  }
);

/* The above code is adding an event listener to each span element with the role of checkbox. The event
listener is listening for the enter or space key to be pressed. If the enter or space key is
pressed, the code will check the checkbox that is associated with the span element. */
document.querySelectorAll('span[role="checkbox"]').forEach((element) => {
  element.addEventListener('keydown', function (ev) {
    // @ts-ignore
    if (ev.code === 'Enter' || ev.code === 'Space') {
      const selected = this.parentElement.previousElementSibling;
      /**
       * @const
       * @type  {HTMLInputElement}
       */
      // @ts-ignore
      const elt = document.getElementById(`${selected.id}`);
      elt.checked = !elt.checked;
      this.setAttribute('aria-checked', String(!selected));
    }
  });
});

/* Adding an event listener to each input element with the form attribute of "reserve" and calling the
valid function on each change. */
/**
 *
 * @param   {HTMLInputElement}  el
 *
 */
document.querySelectorAll('input[form="reserve"]').forEach((el) => {
  // @ts-ignore
  el.addEventListener('change', () => valid(el));
});

/**
 * The above code is listening for a submit event on the form. If the form is valid, it will send the
form data to the console. If the form is not valid, it will prevent the form from submitting.
 *
 * @param   {String}  submit  [submit description]
 * @param   {SubmitEvent}  ev      [ev description]
 *
 */
reserve.addEventListener('submit', function (ev) {
  if (!validate()) {
    ev.preventDefault();
  } else {
    const data = Object.fromEntries(new FormData(this));
    // eslint-disable-next-line no-console
    console.table(data);
    // new Response(new FormData(reserve)).text().then(console.log);
    // send form by Ajax
    // @ts-ignore
    reserve.reset();
    document
      .querySelectorAll('.formData')
      .forEach((div) => div.classList.remove('valid'));
    closeModal(ev);
    // @ts-ignore
    displaySuccessModal(data.first, data.last);
  }
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#birthdate">birthdate</a></li><li><a href="global.html#birthdateValid">birthdateValid</a></li><li><a href="global.html#btn">btn</a></li><li><a href="global.html#cgu">cgu</a></li><li><a href="global.html#cguChecked">cguChecked</a></li><li><a href="global.html#closeModal">closeModal</a></li><li><a href="global.html#dialog">dialog</a></li><li><a href="global.html#displaySuccessModal">displaySuccessModal</a></li><li><a href="global.html#editNav">editNav</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#emailValid">emailValid</a></li><li><a href="global.html#first">first</a></li><li><a href="global.html#firstValid">firstValid</a></li><li><a href="global.html#icon">icon</a></li><li><a href="global.html#isSelected">isSelected</a></li><li><a href="global.html#last">last</a></li><li><a href="global.html#lastValid">lastValid</a></li><li><a href="global.html#myLinks">myLinks</a></li><li><a href="global.html#notEmpty">notEmpty</a></li><li><a href="global.html#notNull">notNull</a></li><li><a href="global.html#openModal">openModal</a></li><li><a href="global.html#quantity">quantity</a></li><li><a href="global.html#quantityValid">quantityValid</a></li><li><a href="global.html#removeErrMsg">removeErrMsg</a></li><li><a href="global.html#reserve">reserve</a></li><li><a href="global.html#setActive">setActive</a></li><li><a href="global.html#setErrMsg">setErrMsg</a></li><li><a href="global.html#setToOpenModal">setToOpenModal</a></li><li><a href="global.html#testRegExp">testRegExp</a></li><li><a href="global.html#trapFocus">trapFocus</a></li><li><a href="global.html#valid">valid</a></li><li><a href="global.html#validate">validate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Tue May 31 2022 23:14:19 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
